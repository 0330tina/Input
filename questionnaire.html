<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0d9488">
  <meta name="format-detection" content="telephone=no">
  <title>可用性評估問卷 | IHCA 風險預測平台</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="questionnaire-page">
  <header class="header header-result">
    <div class="header-inner">
      <h1>可用性評估問卷</h1>
    </div>
  </header>

  <main class="questionnaire-main">
    <p class="questionnaire-desc">
      本問卷旨在評估本平台之可用性，請依據您實際操作經驗勾選。填答採匿名，僅供學術與系統改善使用。<br>
      <strong>1 = 非常不同意　2 = 不同意　3 = 普通　4 = 同意　5 = 非常同意</strong>
    </p>

    <form id="usability-form" class="questionnaire-card">
      <div class="q-item">
        <label class="q-label">填寫身分</label>
        <div class="q-options" role="group" aria-label="填寫身分">
          <label class="q-opt"><input type="radio" name="role" value="醫師"> 醫師</label>
          <label class="q-opt"><input type="radio" name="role" value="護理師"> 護理師</label>
          <label class="q-opt"><input type="radio" name="role" value="關懷師"> 關懷師</label>
          <label class="q-opt"><input type="radio" name="role" value="醫檢師"> 醫檢師</label>
        </div>
      </div>
      <div class="q-item">
        <label class="q-label">1. 本系統容易學習與操作。</label>
        <div class="q-options" role="group" aria-label="題目1">
          <label class="q-opt"><input type="radio" name="q1" value="1"> 1</label>
          <label class="q-opt"><input type="radio" name="q1" value="2"> 2</label>
          <label class="q-opt"><input type="radio" name="q1" value="3"> 3</label>
          <label class="q-opt"><input type="radio" name="q1" value="4"> 4</label>
          <label class="q-opt"><input type="radio" name="q1" value="5"> 5</label>
        </div>
      </div>
      <div class="q-item">
        <label class="q-label">2. 不需他人協助即可獨立完成風險評估流程。</label>
        <div class="q-options" role="group" aria-label="題目2">
          <label class="q-opt"><input type="radio" name="q2" value="1"> 1</label>
          <label class="q-opt"><input type="radio" name="q2" value="2"> 2</label>
          <label class="q-opt"><input type="radio" name="q2" value="3"> 3</label>
          <label class="q-opt"><input type="radio" name="q2" value="4"> 4</label>
          <label class="q-opt"><input type="radio" name="q2" value="5"> 5</label>
        </div>
      </div>
      <div class="q-item">
        <label class="q-label">3. 我能有效率地完成資料輸入並取得風險評估結果。</label>
        <div class="q-options" role="group" aria-label="題目3">
          <label class="q-opt"><input type="radio" name="q3" value="1"> 1</label>
          <label class="q-opt"><input type="radio" name="q3" value="2"> 2</label>
          <label class="q-opt"><input type="radio" name="q3" value="3"> 3</label>
          <label class="q-opt"><input type="radio" name="q3" value="4"> 4</label>
          <label class="q-opt"><input type="radio" name="q3" value="5"> 5</label>
        </div>
      </div>
      <div class="q-item">
        <label class="q-label">4. 介面資訊編排清楚，易於理解。</label>
        <div class="q-options" role="group" aria-label="題目4">
          <label class="q-opt"><input type="radio" name="q4" value="1"> 1</label>
          <label class="q-opt"><input type="radio" name="q4" value="2"> 2</label>
          <label class="q-opt"><input type="radio" name="q4" value="3"> 3</label>
          <label class="q-opt"><input type="radio" name="q4" value="4"> 4</label>
          <label class="q-opt"><input type="radio" name="q4" value="5"> 5</label>
        </div>
      </div>
      <div class="q-item">
        <label class="q-label">5. 風險評估結果的呈現方式易於解讀。</label>
        <div class="q-options" role="group" aria-label="題目5">
          <label class="q-opt"><input type="radio" name="q5" value="1"> 1</label>
          <label class="q-opt"><input type="radio" name="q5" value="2"> 2</label>
          <label class="q-opt"><input type="radio" name="q5" value="3"> 3</label>
          <label class="q-opt"><input type="radio" name="q5" value="4"> 4</label>
          <label class="q-opt"><input type="radio" name="q5" value="5"> 5</label>
        </div>
      </div>
      <div class="q-item">
        <label class="q-label">6. 整體而言，我認為本系統具有良好可用性，願意在臨床情境中使用。</label>
        <div class="q-options" role="group" aria-label="題目6">
          <label class="q-opt"><input type="radio" name="q6" value="1"> 1</label>
          <label class="q-opt"><input type="radio" name="q6" value="2"> 2</label>
          <label class="q-opt"><input type="radio" name="q6" value="3"> 3</label>
          <label class="q-opt"><input type="radio" name="q6" value="4"> 4</label>
          <label class="q-opt"><input type="radio" name="q6" value="5"> 5</label>
        </div>
      </div>
      <div class="q-item q-item-open">
        <label class="q-label" for="q7">7. 請簡述您對本平台介面、操作流程或功能之改進建議。（選填）</label>
        <textarea id="q7" name="q7" class="q-textarea" rows="4" placeholder="請輸入您的建議…"></textarea>
      </div>
      <div class="questionnaire-actions">
        <button type="submit" class="btn btn-primary">提交問卷</button>
        <a href="result.html" class="btn btn-outline">返回結果頁</a>
      </div>
    </form>

    <div id="questionnaire-thanks" class="questionnaire-thanks hidden">
      <p class="thanks-title">感謝您的填答</p>
      <p class="thanks-text">您的意見將作為系統改善與研究分析之用。</p>
      <p id="thanks-google-msg" class="thanks-google-msg hidden">您的回覆已存至 Google 試算表。</p>
      <div class="questionnaire-actions">
        <a href="index.html" class="btn btn-primary">回首頁</a>
      </div>
    </div>
  </main>

  <script>
    (function () {
      var GOOGLE_SCRIPT_URL = 'function doPost(e) {
  try {
    var spreadsheetId = '1c-tjSKk7SmY0ILJvqWVj1OEn71sSWRbjL1OIfhnAJcE';
    var sheetName = '工作表1'; // ←改成你的分頁名稱，例如「工作表1」

    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName(sheetName) || ss.getActiveSheet();

    // 讀取前端送來的 JSON
    var raw;
    if (e && e.parameter && e.parameter.data) raw = e.parameter.data;
    else if (e && e.postData && e.postData.contents) raw = e.postData.contents;
    else return jsonResponse_({ success: false, error: '無法取得資料（沒有收到 data 或 body）' });

    var data = JSON.parse(raw);

    // 支援前端欄位：timestamp 或 at；身分 或 role
    var inputTime = parseToDateOrText_(data.timestamp != null ? data.timestamp : data.at);
    var identity = safeText_(data['身分'] != null ? data['身分'] : data.role);

    var q1 = safeText_(data.q1);
    var q2 = safeText_(data.q2);
    var q3 = safeText_(data.q3);
    var q4 = safeText_(data.q4);
    var q5 = safeText_(data.q5);
    var q6 = safeText_(data.q6);
    var q7 = safeText_(data.q7);

    // 寫入：時間、身分、Q1~Q7
    var row = [inputTime, identity, q1, q2, q3, q4, q5, q6, q7];

    var lock = LockService.getScriptLock();
    lock.waitLock(10000);
    try {
      sheet.appendRow(row);
    } finally {
      lock.releaseLock();
    }

    return jsonResponse_({ success: true, message: '已寫入：時間、身分、Q1~Q7' });

  } catch (error) {
    return jsonResponse_({ success: false, error: String(error) });
  }
}

function doGet(e) {
  return ContentService.createTextOutput('問卷 API 已就緒')
    .setMimeType(ContentService.MimeType.TEXT);
}

function jsonResponse_(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function safeText_(v) {
  if (v === null || v === undefined) return '';
  return String(v);
}

function parseToDateOrText_(v) {
  if (v === null || v === undefined) return '';
  if (typeof v === 'number') {
    if (v < 1e12) return new Date(v * 1000);
    return new Date(v);
  }
  if (typeof v === 'string') {
    var s = v.trim();
    if (!s) return '';
    var normalized = s.replace(' ', 'T');
    var d = new Date(normalized);
    if (!isNaN(d.getTime())) return d;
    return s;
  }
  return String(v);
}

/**
 * ✅ 不用前端！直接按一下就寫入一筆測試資料到試算表
 */
function testAppend() {
  var fake = {
    timestamp: "2026-02-08 14:30:12",
    "身分": "護理師",
    q1: "1",
    q2: "1",
    q3: "1",
    q4: "1",
    q5: "1",
    q6: "1",
    q7: "1"
  };

  // 模擬 doPost 收到的 e
  var e = { postData: { contents: JSON.stringify(fake) } };
  var res = doPost(e);
  Logger.log(res.getContent());
}';

      var form = document.getElementById('usability-form');
      var thanks = document.getElementById('questionnaire-thanks');

      function collectPayload() {
        var roleEl = form.querySelector('input[name="role"]:checked');
        var role = roleEl ? roleEl.value : '';
        var q1to6 = [];
        for (var i = 1; i <= 6; i++) {
          var r = form.querySelector('input[name="q' + i + '"]:checked');
          q1to6.push(r ? r.value : '');
        }
        var q7 = form.querySelector('#q7').value.trim();
        return {
          role: role,
          q1: q1to6[0], q2: q1to6[1], q3: q1to6[2], q4: q1to6[3], q5: q1to6[4], q6: q1to6[5],
          q7: q7,
          at: new Date().toISOString()
        };
      }

      function showThanks() {
        form.classList.add('hidden');
        thanks.classList.remove('hidden');
        var googleMsg = document.getElementById('thanks-google-msg');
        if (googleMsg) googleMsg.classList.remove('hidden');
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var payload = collectPayload();
        try {
          localStorage.setItem('ihca_usability', JSON.stringify(payload));
        } catch (err) {}

        if (!GOOGLE_SCRIPT_URL) {
          showThanks();
          return;
        }
        if (GOOGLE_SCRIPT_URL.indexOf('/exec') === -1) {
          alert('請確認 GOOGLE_SCRIPT_URL 為正式部署網址（結尾為 /exec），目前可能為測試網址（/dev）。');
        }

        fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        })
          .then(function () {
            if (typeof console !== 'undefined' && console.log) {
              console.log('[問卷] 已送出至 Google 試算表');
            }
            showThanks();
          })
          .catch(function (err) {
            if (typeof console !== 'undefined' && console.error) console.error('[問卷] 送出失敗', err);
            showThanks();
          });
      });
    })();
  </script>
</body>
</html>

